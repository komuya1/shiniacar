<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OpenStreetMap ã‚·ãƒ‹ã‚¢ã‚«ãƒ¼ãƒŠãƒ“ï¼ˆARä»˜ãï¼‰</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body { font-family:"Noto Sans JP",sans-serif; margin:0; background:#f0f0f0; display:flex; flex-direction:column; height:100vh; }
    header { background:#2c3e50; color:white; text-align:center; padding:12px; font-size:1.6rem; }
    #controls { display:flex; gap:12px; padding:14px; background:#ecf0f1; flex-wrap:wrap; justify-content:center; }
    input { padding:16px; font-size:1.3rem; border-radius:10px; border:1px solid #bbb; flex:1; min-width:200px; }
    button { padding:16px 20px; font-size:1.3rem; border:none; border-radius:12px; background:#3498db; color:white; cursor:pointer; font-weight:bold; }
    button:hover { background:#2980b9; }
    #map { flex:1; min-height:200px; }
    #summary { text-align:center; padding:12px; background:#fff; border-top:1px solid #ccc; font-size:1.3rem; }
    #loading { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:rgba(0,0,0,0.7); color:white; padding:20px 30px; border-radius:14px; font-size:1.4rem; display:none; z-index:1000; }
    #arContainer { position:absolute; top:0; left:0; right:0; bottom:0; display:none; z-index:1200; pointer-events:none; }
    #cameraVideo { position:absolute; top:0; left:0; width:100%; height:100%; object-fit:cover; transform:scaleX(-1); }
    #arOverlay { position:absolute; top:0; left:0; right:0; bottom:0; display:flex; flex-direction:column; justify-content:space-between; pointer-events:none; }
    .arTop { display:flex; justify-content:space-between; padding:16px; font-size:1.3rem; color:white; text-shadow:0 1px 3px rgba(0,0,0,.7); pointer-events:auto; }
    .arCenter { display:flex; align-items:center; justify-content:center; pointer-events:none; }
    .arrow { width:160px; height:160px; transition:transform 0.2s linear; transform-origin:50% 50%; filter:drop-shadow(0 4px 6px rgba(0,0,0,0.6)); }
    .distanceBox { margin-top:12px; background:rgba(0,0,0,0.5); color:white; padding:12px 16px; border-radius:12px; font-weight:bold; font-size:1.4rem; text-align:center; }
    #arControls { position:absolute; top:16px; right:16px; z-index:1300; display:flex; gap:12px; pointer-events:auto; }
    #arControls button { background:rgba(255,255,255,0.9); color:#333; padding:14px 20px; font-size:1.2rem; border-radius:12px; font-weight:600; }
    footer { text-align:center; padding:12px; font-size:1.1rem; color:#555; }
  </style>
</head>
<body>
  <header>OpenStreetMap ã‚·ãƒ‹ã‚¢ã‚«ãƒ¼ãƒŠãƒ“ï¼ˆARä»˜ãï¼‰</header>

  <div id="controls">
    <input id="from" type="text" placeholder="å‡ºç™ºåœ°ï¼ˆä¾‹ï¼šç¾åœ¨åœ°ï¼‰">
    <input id="to" type="text" placeholder="ç›®çš„åœ°ï¼ˆä¾‹ï¼šæ±äº¬ã‚¿ãƒ¯ãƒ¼ï¼‰">
    <button id="goBtn">ãƒ«ãƒ¼ãƒˆè¡¨ç¤º</button>
    <button id="gpsBtn">ğŸ“ ç¾åœ¨åœ°</button>
    <button id="arBtn">ğŸ“¸ ARãƒ¢ãƒ¼ãƒ‰</button>
  </div>

  <div id="map"></div>
  <div id="summary"></div>
  <div id="loading">ãƒ«ãƒ¼ãƒˆã‚’æ¤œç´¢ä¸­...</div>

  <div id="arContainer" aria-hidden="true">
    <video id="cameraVideo" autoplay playsinline muted></video>
    <div id="arOverlay">
      <div class="arTop">
        <div id="arStatus">ARãƒ¢ãƒ¼ãƒ‰</div>
        <div id="arDistance"></div>
      </div>
      <div class="arCenter">
        <div style="text-align:center;">
          <svg class="arrow" id="arrowSvg" viewBox="0 0 100 100">
            <polygon points="50,5 90,90 50,75 10,90" fill="rgba(255,255,255,0.95)"/>
          </svg>
          <div class="distanceBox" id="arInfo">-- m</div>
        </div>
      </div>
      <div style="display:flex; justify-content:center; padding:12px;">
        <div id="arHint" style="color:white; text-shadow:0 1px 3px rgba(0,0,0,.7)">ç«¯æœ«ã‚’å›ã—ã¦é€²è¡Œæ–¹å‘ã«åˆã‚ã›ã¦ãã ã•ã„</div>
      </div>
    </div>

    <div id="arControls">
      <button id="stopArBtn">ARçµ‚äº†</button>
    </div>
  </div>

  <footer>Â© OpenStreetMap contributors | OSRMçµŒè·¯APIä½¿ç”¨</footer>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
  // ==== åœ°å›³åˆæœŸåŒ– ====
  const map = L.map('map').setView([35.6812, 139.7671], 13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    attribution:'Â© OpenStreetMap contributors'
  }).addTo(map);

  let routeLine=null, markers=[], currentLocation=null, route=null, routeCoords=[];

  async function getCoordinates(place){
    if(!place) return null;
    const r=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(place)}`);
    const d=await r.json();
    if(!d||d.length===0) return null;
    return [parseFloat(d[0].lat), parseFloat(d[0].lon)];
  }

  function getCurrentLocation(){
    if(!navigator.geolocation){ alert('GPSãŒä½¿ãˆã¾ã›ã‚“'); return; }
    navigator.geolocation.getCurrentPosition(p=>{
      currentLocation=[p.coords.latitude,p.coords.longitude];
      map.setView(currentLocation,14);
      L.marker(currentLocation).addTo(map).bindPopup('ğŸ“ ç¾åœ¨åœ°').openPopup();
      document.getElementById('from').value='ç¾åœ¨åœ°';
    },e=>alert('ç¾åœ¨åœ°ã‚’å–å¾—ã§ãã¾ã›ã‚“: '+e.message),{enableHighAccuracy:true});
  }

  async function drawRoute(){
    const fromInput=document.getElementById('from').value.trim();
    const toInput=document.getElementById('to').value.trim();
    const summary=document.getElementById('summary');
    const loading=document.getElementById('loading');
    summary.textContent='';
    if(!toInput){ summary.textContent='ç›®çš„åœ°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'; return; }

    loading.style.display='block';
    let fromCoords;
    if(fromInput==='ç¾åœ¨åœ°' && currentLocation) fromCoords=currentLocation; else fromCoords=await getCoordinates(fromInput);
    const toCoords=await getCoordinates(toInput);
    if(!fromCoords||!toCoords){ loading.style.display='none'; summary.textContent='åœ°åãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'; return; }

    const url=`https://router.project-osrm.org/route/v1/bike/${fromCoords[1]},${fromCoords[0]};${toCoords[1]},${toCoords[0]}?overview=full&geometries=geojson&steps=true`;
    const res=await fetch(url); const data=await res.json(); loading.style.display='none';
    if(!data.routes||data.routes.length===0){ summary.textContent='ãƒ«ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ'; return; }

    route=data.routes[0];
    routeCoords=route.geometry.coordinates.map(c=>[c[1],c[0]]);

    if(routeLine) map.removeLayer(routeLine);
    markers.forEach(m=>map.removeLayer(m)); markers=[];

    routeLine=L.polyline(routeCoords,{color:'#00b894',weight:6}).addTo(map);
    map.fitBounds(routeLine.getBounds());

    markers.push(L.marker(fromCoords).addTo(map).bindPopup('å‡ºç™ºåœ°'));
    markers.push(L.marker(toCoords).addTo(map).bindPopup('ç›®çš„åœ°'));

    const distKm=(route.distance/1000).toFixed(1);
    const seniorSpeed=6; // km/h
    const timeMin=Math.round((distKm/seniorSpeed)*60);
    summary.innerHTML=`<b>è·é›¢:</b> ${distKm} km ï¼ <b>æ‰€è¦æ™‚é–“:</b> ç´„${timeMin}åˆ†`;
    speak(`è·é›¢ã¯ç´„${distKm}ã‚­ãƒ­ã€ã‚·ãƒ‹ã‚¢ã‚«ãƒ¼ã§ã®æ‰€è¦æ™‚é–“ã¯ãŠã‚ˆã${timeMin}åˆ†ã§ã™ã€‚`);
  }

  function speak(t){ if(!('speechSynthesis' in window)) return; const u=new SpeechSynthesisUtterance(t); u.lang='ja-JP'; u.rate=1; speechSynthesis.speak(u); }

  document.getElementById('gpsBtn').addEventListener('click',getCurrentLocation);
  document.getElementById('goBtn').addEventListener('click',drawRoute);

  // ==== ARé–¢é€£ï¼ˆå®‰å®šåŒ–ç‰ˆï¼‰====
  const arBtn=document.getElementById('arBtn');
  const arContainer=document.getElementById('arContainer');
  const cameraVideo=document.getElementById('cameraVideo');
  const arrowSvg=document.getElementById('arrowSvg');
  const arInfo=document.getElementById('arInfo');
  const arDistance=document.getElementById('arDistance');
  const arStatus=document.getElementById('arStatus');
  const stopArBtn=document.getElementById('stopArBtn');

  // é‡è¦: ãƒªã‚¢ã‚«ãƒ¡ãƒ©ã¯å·¦å³åè»¢ã—ãªã„ï¼ˆæ··ä¹±ã®åŸå› ã«ãªã‚‹ãŸã‚ï¼‰
  // CSSã® scaleX(-1) ã‚’è§£é™¤
  cameraVideo.style.transform='none';

  let arStream=null, watchingPositionId=null, deviceHeading=null, orientationListener=null;
  let lastGeoHeading=null, lastGeoTime=0;

  function screenOrientationOffset(){
    // ç«¯æœ«ã®å‘ãã«ã‚ˆã‚‹alphaè£œæ­£ï¼ˆiOS/Androidå·®ç•°å¯¾ç­–ï¼‰
    const o = (screen.orientation && typeof screen.orientation.angle==='number') ? screen.orientation.angle : (window.orientation||0);
    return (o||0);
  }

  function requestOrientationPermission(){
    return new Promise((resolve,reject)=>{
      if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
        DeviceOrientationEvent.requestPermission().then(state=>{
          if(state==='granted') resolve(true); else resolve(false);
        }).catch(()=>resolve(false));
      } else {
        resolve(true); // Android/PCç­‰ã¯ä¸è¦
      }
    });
  }

  function setupOrientationListener(){
    function handle(e){
      if (typeof e.webkitCompassHeading === 'number') {
        // iOS ã®ã‚³ãƒ³ãƒ‘ã‚¹(çœŸåŒ—åŸºæº–)
        deviceHeading = e.webkitCompassHeading; // 0..360 (æ™‚è¨ˆå›ã‚Š)
      } else if (typeof e.alpha === 'number') {
        // alphaã¯ç«¯æœ«åŸºæº–ã€‚ç”»é¢å›è»¢ã‚’è£œæ­£ã—åŒ—åŸºæº–ã«è¿‘ã¥ã‘ã‚‹ã€‚
        const off = screenOrientationOffset();
        deviceHeading = (360 - (e.alpha + off)) % 360;
      }
    }
    window.addEventListener('deviceorientation', handle, true);
    orientationListener = handle;
  }

  function stopOrientationListener(){
    if(orientationListener){ window.removeEventListener('deviceorientation',orientationListener,true); orientationListener=null; }
  }

  async function startCamera(){
    try{
      arStream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:{ideal:'environment'} }, audio:false });
      cameraVideo.srcObject = arStream;
      await cameraVideo.play();
      arContainer.style.display='block';
    }catch(e){ alert('ã‚«ãƒ¡ãƒ©ã‚’é–‹å§‹ã§ãã¾ã›ã‚“: '+e.message); }
  }

  function stopCamera(){
    if(arStream){ arStream.getTracks().forEach(t=>t.stop()); arStream=null; }
    cameraVideo.pause(); cameraVideo.srcObject=null; arContainer.style.display='none';
  }

  function bearingBetween(lat1,lon1,lat2,lon2){
    const R=Math.PI/180; const dLon=(lon2-lon1)*R;
    const y=Math.sin(dLon)*Math.cos(lat2*R);
    const x=Math.cos(lat1*R)*Math.sin(lat2*R)-Math.sin(lat1*R)*Math.cos(lat2*R)*Math.cos(dLon);
    let b=Math.atan2(y,x)*180/Math.PI; return (b+360)%360;
  }

  function hav(lat1,lon1,lat2,lon2){
    const R=6371000, toR=Math.PI/180; const dLat=(lat2-lat1)*toR, dLon=(lon2-lon1)*toR;
    const a=Math.sin(dLat/2)**2 + Math.cos(lat1*toR)*Math.cos(lat2*toR)*Math.sin(dLon/2)**2;
    return 2*R*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
  }

  function findNextPointOnRoute(cur){
    if(!routeCoords||routeCoords.length===0) return null;
    let min=Infinity, idx=0;
    for(let i=0;i<routeCoords.length;i++){
      const p=routeCoords[i]; const d=hav(cur[0],cur[1],p[0],p[1]);
      if(d<min){ min=d; idx=i; }
    }
    const next=Math.min(idx+8, routeCoords.length-1);
    return { point:routeCoords[next], distToPoint: hav(cur[0],cur[1],routeCoords[next][0],routeCoords[next][1]) };
  }

  function startWatchingPosition(){
    if(!navigator.geolocation){ alert('ä½ç½®æƒ…å ±ãŒä½¿ãˆã¾ã›ã‚“'); return; }
    if(watchingPositionId!==null) return;
    watchingPositionId = navigator.geolocation.watchPosition(p=>{
      currentLocation=[p.coords.latitude,p.coords.longitude];
      // ãƒ–ãƒ©ã‚¦ã‚¶ãŒè¨ˆç®—ã—ãŸæ–¹ä½(heading)ãŒã‚ã‚Œã°å„ªå…ˆï¼ˆç§»å‹•ä¸­ã®ã¿å¾—ã‚‰ã‚Œã‚‹ï¼‰
      if(typeof p.coords.heading === 'number' && !Number.isNaN(p.coords.heading)){
        lastGeoHeading = (p.coords.heading+360)%360; // 0=åŒ—, æ™‚è¨ˆå›ã‚Š
        lastGeoTime = Date.now();
      }
      updateAR();
    }, err=>{ console.warn('ä½ç½®ç›£è¦–ã‚¨ãƒ©ãƒ¼', err); }, { enableHighAccuracy:true, maximumAge:500, timeout:5000 });
  }

  function stopWatchingPosition(){ if(watchingPositionId!==null){ navigator.geolocation.clearWatch(watchingPositionId); watchingPositionId=null; } }

  function currentHeading(){
    // ç›´è¿‘2ç§’ä»¥å†…ã®GPS headingãŒã‚ã‚Œã°ãã‚Œã‚’ä½¿ã†ï¼ˆæ­©è¡Œ/èµ°è¡Œæ™‚ã«å®‰å®šï¼‰
    if(lastGeoHeading!==null && Date.now()-lastGeoTime < 2000) return lastGeoHeading;
    // ç„¡ã‘ã‚Œã°ãƒ‡ãƒã‚¤ã‚¹æ–¹ä½ã‚»ãƒ³ã‚µãƒ¼
    if(typeof deviceHeading==='number') return (deviceHeading+360)%360;
    return 0;
  }

  let lastSpokenStep=null;
  function updateAR(){
    if(!currentLocation || !routeCoords || routeCoords.length===0){ arInfo.textContent='-- m'; return; }
    const next=findNextPointOnRoute(currentLocation); if(!next) return;
    const t=next.point; const dist=Math.round(next.distToPoint);
    const bearing=bearingBetween(currentLocation[0],currentLocation[1],t[0],t[1]);
    const heading=currentHeading();
    const relative=((bearing - heading + 540)%360)-180; // -180..180
    arrowSvg.style.transform = `rotate(${relative}deg)`;
    arInfo.textContent = `${dist} m`;
    arDistance.textContent = `ç›®æ¨™ã¾ã§ ${dist} m`;

    if(dist<50 && lastSpokenStep!=='near'){ speak('ç›®çš„åœ°ãŒè¿‘ã¥ã„ã¦ã„ã¾ã™ã€‚æ¸›é€Ÿã«ã”æ³¨æ„ãã ã•ã„ã€‚'); lastSpokenStep='near'; }
    else if(dist>=50){ lastSpokenStep=null; }
  }

  async function startAR(){
    if(!route||!routeCoords||routeCoords.length===0){ alert('ARã®å‰ã«ã€Œãƒ«ãƒ¼ãƒˆè¡¨ç¤ºã€ã§ç›®çš„åœ°ã‚’è¨­å®šã—ã¦ãã ã•ã„'); return; }

    // iOSã®æ–¹ä½è¨±å¯
    const ok = await requestOrientationPermission();
    if(!ok){ arStatus.textContent='å‘ãæƒ…å ±ã®è¨±å¯ãŒå¿…è¦ã§ã™ï¼ˆè¨­å®šã§è¨±å¯ã—ã¦ãã ã•ã„ï¼‰'; }

    await startCamera();
    setupOrientationListener();
    startWatchingPosition();

    arContainer.style.display='block';
    arStatus.textContent='ARãƒ¢ãƒ¼ãƒ‰ï¼ˆã‚«ãƒ¡ãƒ©ãƒ»ä½ç½®ãƒ»æ–¹ä½ã‚’ä½¿ç”¨ï¼‰';
    speak('ARãƒŠãƒ“ã‚’é–‹å§‹ã—ã¾ã™ã€‚ç«¯æœ«ã‚’é€²è¡Œæ–¹å‘ã¸å‘ã‘ã¦ãã ã•ã„ã€‚');
    updateAR();
  }

  arBtn.addEventListener('click', startAR);

  stopArBtn.addEventListener('click', ()=>{
    stopCamera(); stopWatchingPosition(); stopOrientationListener();
    arContainer.style.display='none';
    speak('ARãƒ¢ãƒ¼ãƒ‰ã‚’çµ‚äº†ã—ã¾ã—ãŸã€‚');
  });

  window.addEventListener('beforeunload', ()=>{ stopCamera(); stopWatchingPosition(); stopOrientationListener(); });

  map.on('click', e=>{ currentLocation=[e.latlng.lat, e.latlng.lng]; if(routeLine) map.panTo(e.latlng); });

  document.addEventListener('DOMContentLoaded', ()=>{
    document.getElementById('summary').textContent='ç›®çš„åœ°ã‚’å…¥åŠ›ã—ã¦ã€Œãƒ«ãƒ¼ãƒˆè¡¨ç¤ºã€ã€‚ARã¯HTTPSç’°å¢ƒã¨å±‹å¤–ã§ã®ä½¿ç”¨ã‚’æ¨å¥¨ã—ã¾ã™ã€‚';
  });
</script>
</body>
</html>
